"use strict";angular.module("app",["loopBackAuthFactories","ui.router","ui.bootstrap","ngCookies","satellizer","angularModalService"]).value("Config",{youtubeKey:"AIzaSyCqR1vxxGI7Qz9W-N3IJDF0E1-9DoPuhjw"}).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,o){e.state("home",{url:"/home",templateUrl:"views/content.html",controller:"ContentCtrl"}).state("collect",{url:"/collect",templateUrl:"views/collection.html",controller:"CollectionCtrl"}).state("mypage",{url:"/mypage",templateUrl:"views/mypage.html",controller:"MypageCtrl"}).state("test",{url:"/test",templateUrl:"views/test.html",controller:"TestCtrl"}),t.otherwise("home"),o.html5Mode(!0)}]).config(["satellizer.config","$authProvider",function(e,t){e.authHeader="Satellizer",e.httpInterceptor=!1,t.facebook({clientId:"652372928198212"}),t.google({clientId:"968064961666-g85aklkfvmi4du3i7f7qr51oq01umgov.apps.googleusercontent.com"})}]).filter("secondsToDateTime",[function(){return function(e){return new Date(1970,0,1).setSeconds(e)}}]),angular.module("app").controller("CollectionCtrl",["$scope","$window","$http","Collection","Content","Config","Youtube","ModalService",function(e,t,o,n,r,l,i,c){e.reset=function(){e.contents=[],e.filter.skip=0,e.disabled=!1,e.loadMore()},e.loadMore=function(){e.disabled=!0,n.find({filter:e.filter}).$promise.then(function(t){t.length>0?(angular.forEach(t,function(t){i.channel({key:l.youtubeKey,id:t.channelId,part:"statistics"}).$promise.then(function(e){var o=e.items[0].statistics;t.viewCount=o.viewCount,t.commentCount=o.commentCount,t.subscriberCount=o.subscriberCount,t.videoCount=o.videoCount}),s(t.channelId).then(function(e){t.count=e}),e.contents.push(t)}),e.disabled=!1):e.disabled=!0},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){e.filter.skip=e.filter.skip+15})};var s=function(e){var t=r.count({where:{channelId:e}}).$promise.then(function(e){return e.count},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){});return t};e.filter={order:name,limit:"15",skip:e.skip},e.reset(),e.CollectById=function(t,n){var r=$(n.target).data("id");console.log(e.contents[t]),e.contents[t].state=!0,o({method:"POST",url:"/executeById",headers:{"Content-Type":"application/json; charset=utf-8"},data:{channelId:r},type:"json"}).success(function(e){var t=JSON.parse(JSON.stringify(e));console.log(t)}).finally(function(){console.log("Complete")})},e.deleteCollection=function(e,o){c.showModal({templateUrl:"views/modal/confirm/confirm.html",controller:"ConfirmModalControllers"}).then(function(o){o.element.modal(),o.close.then(function(o){o&&n.delete({id:e}).$promise.then(function(e){t.location.reload()},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){})})})},e.updateCollection=function(e,o){n.update({id:e,state:!1}).$promise.then(function(e){console.log(e),t.location.reload()},function(e){console.log("err :: "+JSON.stringify(e))})},window.onscroll=function(t){window.innerHeight+window.scrollY>=document.body.offsetHeight&&(e.disabled||e.loadMore())}}]),angular.module("app").controller("ContentCtrl",["$rootScope","$scope","Content","Collection","Youtube","Config",function(e,t,o,n,r,l){e.$on("selectFilter",function(e,o){t.selectChannel(o)}),t.banners=[],n.find({filter:{fields:{channelId:!0,thumbnails:!0,channelTitle:!0},order:name,limit:"5"}}).$promise.then(function(e){angular.forEach(e,function(e){r.channel({key:l.youtubeKey,id:e.channelId,part:"brandingSettings"}).$promise.then(function(t){e.bannerImg=t.items[0].brandingSettings.image.bannerMobileMediumHdImageUrl})}),t.banners=t.banners.concat(e)}),t.reset=function(){t.contents=[],t.filter.skip=0,t.disabled=!1,t.loadMore()},t.loadMore=function(){t.disabled=!0,o.find({filter:t.filter}).$promise.then(function(e){e.length>0?(t.contents=t.contents.concat(e),t.disabled=!1):t.disabled=!0},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){t.filter.skip=t.filter.skip+15})},t.selectChannel=function(e){"all"===e?t.filter={include:["audios"],order:"publishedAt DESC",limit:"15",skip:0,where:{deleted:!1}}:t.filter={include:["audios"],order:"publishedAt DESC",limit:"15",skip:0,where:{channelId:e,deleted:!1}},t.reset()},t.filter={include:["audios"],order:"publishedAt DESC",limit:"15",skip:t.skip,where:{deleted:!1}},t.reset(),window.onscroll=function(e){window.innerHeight+window.scrollY>=document.body.offsetHeight&&(t.disabled||t.loadMore())}}]),angular.module("app").controller("MypageCtrl",["$rootScope","$scope","$window","User","Content","Config","Youtube","ModalService","LoopBackAuth",function(e,t,o,n,r,l,i,c,s){e.$on("selectMyChannel",function(e,o){t.filter={include:["audios"],order:"publishedAt DESC",limit:"15",skip:0,where:{channelId:o,deleted:!1}},t.reset()}),t.LoopBackAuth=s,t.reset=function(){t.contents=[],t.filter.skip=0,t.disabled=!1,t.loadMore()},t.loadMore=function(){t.disabled=!0,r.find({filter:t.filter}).$promise.then(function(e){console.log(e),e.length>0?(t.contents=t.contents.concat(e),t.disabled=!1):t.disabled=!0},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){t.filter.skip=t.filter.skip+15})},t.filter={include:["audios"],order:"publishedAt DESC",limit:"15",skip:0,where:{channelId:t.LoopBackAuth.channelId}},window.onscroll=function(e){window.innerHeight+window.scrollY>=document.body.offsetHeight&&(t.disabled||t.loadMore())}}]),angular.module("app").controller("TestCtrl",["$scope",function(e){}]),angular.module("app").factory("Collection",["LoopBackResource","$injector",function(e,t,o){var n="/api",r=e(n+"/collections/:id",{id:"@id"},{find:{url:n+"/collections",method:"GET",isArray:!0},create:{url:n+"/collections",method:"POST"},update:{url:n+"/collections/:id",method:"PUT"},delete:{url:n+"/collections/:id",method:"DELETE"}});return r.updateOrCreate=r.upsert,r.destroyById=r.deleteById,r.removeById=r.deleteById,r.modelName="collection",r}]),angular.module("app").factory("Content",["LoopBackResource","$injector",function(e,t){var o="/api",n=e(o+"/contents/:id",{id:"@id"},{find:{url:o+"/contents",method:"GET",isArray:!0},create:{url:o+"/contents",method:"POST"},count:{url:o+"/contents/count",method:"GET"}});return n.updateOrCreate=n.upsert,n.update=n.updateAll,n.destroyById=n.deleteById,n.removeById=n.deleteById,n.modelName="content",n}]),function(e,t,o){var n="authorization",r=t.module("loopBackAuthFactories",["ngResource"]);r.factory("LoopBackAuth",function(){function e(){var e=this;r.forEach(function(t){e[t]=n(t)}),this.rememberMe=o}function t(e,t,o){var n="$LoopBack$"+t;null==o&&(o=""),e[n]=o}function n(e){var t="$LoopBack$"+e;return localStorage[t]||sessionStorage[t]||null}var r=["accessTokenId","currentUserId","currentUserEmail","youtubeAccessToken"];return e.prototype.save=function(){var e=this,o=this.rememberMe?localStorage:sessionStorage;r.forEach(function(n){t(o,n,e[n])})},e.prototype.setUser=function(e,t,o,n){this.accessTokenId=e,this.currentUserId=t,this.currentUserEmail=o,this.youtubeAccessToken=n},e.prototype.clearUser=function(){this.accessTokenId=null,this.currentUserId=null,this.currentUserEmail=null,this.youtubeAccessToken=null},new e}).config(["$httpProvider",function(e){e.interceptors.push("LoopBackAuthRequestInterceptor")}]).factory("LoopBackAuthRequestInterceptor",["$q","LoopBackAuth","$rootScope",function(e,t,r){var l="/api";return{request:function(r){if(r.url.substr(0,l.length)!==l)return r;if(t.accessTokenId)r.headers[n]=t.accessTokenId;else if(r.__isGetCurrentUser__){var i={body:{error:{status:401}},status:401,config:r,headers:function(){return o}};return e.reject(i)}return r||e.when(r)}}}]).provider("LoopBackResource",function(){this.setAuthHeader=function(e){n=e},this.setUrlBase=function(e){urlBase=e},this.$get=["$resource",function(e){return function(t,o,n){var r=e(t,o,n);return r.prototype.$save=function(e,t){var o=r.upsert.call(this,{},this,e,t);return o.$promise||o},r}}]})}(window,window.angular),angular.module("app").factory("User",["LoopBackResource","LoopBackAuth","$injector",function(e,t,o){var n="/api",r=e(n+"/Users/:userId",{userId:"@userId"},{login:{url:n+"/Users/login",method:"POST",params:{include:"user"},interceptor:{response:function(e){var o=e.data;return t.setUser(o.id,o.userId,o.user),t.rememberMe=e.config.params.rememberMe!==!1,t.save(),e.resource}}},logout:{url:n+"/Users/logout",method:"POST",interceptor:{response:function(e){return t.clearUser(),t.rememberMe=!0,t.save(),e.resource}}},notification:{url:n+"/Users/:userId/notifications",method:"GET",isArray:!0},cleanNotification:{url:n+"/Users/:userId/notifications",method:"PUT"},"::notification::count":{url:n+"/Users/:userId/notifications/count",method:"GET"},collection:{url:n+"/Users/:userId/collection",method:"GET"},content:{url:n+"/Users/:userId/content",method:"GET",isArray:!0},comments:{url:n+"/Users/:userId/comments",method:"GET",isArray:!0},deleteComments:{url:n+"/Users/:userId/comments",method:"PUT"},"::comments::delete":{url:n+"/Users/:userId/comments",method:"DELETE"},create:{url:n+"/Users",method:"POST"},update:{url:n+"/Users/:userId",method:"PUT"},picture:{url:n+"/Users/:userId/picture",method:"GET"},info:{url:n+"/Users/:userId/info",method:"GET"},search:{url:n+"/Users/search?key=:key",method:"GET",isArray:!0},exists:{url:n+"/Users/:userId/exists",method:"GET"},getCurrent:{url:n+"/Users/:id",method:"GET",params:{id:function(){var e=t.currentUserId;return null==e&&(e="__anonymous__"),e}},interceptor:{response:function(e){return t.currentUserData=e.data,e.resource}},__isGetCurrentUser__:!0}});return r.updateOrCreate=r.upsert,r.update=r.updateAll,r.destroyById=r.deleteById,r.removeById=r.deleteById,r.getCachedCurrent=function(){var e=t.currentUserData;return e?new r(e):null},r.isAuthenticated=function(){return null!=this.getCurrentId()},r.getCurrentId=function(){return t.currentUserId},r.modelName="User",r}]),angular.module("app").factory("Youtube",["LoopBackResource","$injector",function(e,t){var o="https://www.googleapis.com/youtube/v3",n=e(o+"key=:key&part=:part",{key:"@key",part:"@part"},{channel:{url:o+"/channels",method:"GET"},myChannel:{url:o+"/channels?mine=true",method:"GET"}});return n.updateOrCreate=n.upsert,n.update=n.updateAll,n.destroyById=n.deleteById,n.removeById=n.deleteById,n.modelName="Youtube",n}]),angular.module("app").directive("footer",function(){return{restrict:"A",scope:{user:"="},templateUrl:"views/directives/footer/footer.html",controller:["$scope","$filter",function(e,t){}]}}),angular.module("app").directive("header",function(){return{restrict:"A",scope:{user:"="},templateUrl:"views/directives/header/header.html",controller:["$scope","$rootScope","$location","$filter","Collection","ModalService","LoopBackAuth","User",function(e,t,o,n,r,l,i,c){e.LoopBackAuth=i,e.login=function(){l.showModal({templateUrl:"views/modal/login/login.html",controller:"LoginModalControllers"}).then(function(e){e.element.modal(),e.close.then(function(e){})})},e.logout=function(){c.logout({access_token:i.accessTokenId}).$promise.then(function(e,t){o.url("/home")},function(e){console.log("login err",JSON.stringify(e))})}}]}}),angular.module("app").directive("sidebar",function(){return{restrict:"A",replace:!0,scope:{user:"="},templateUrl:"views/directives/sidebar/content-sidebar.html",controller:["$rootScope","$scope","$filter","Collection",function(e,t,o,n){t.categories=[],t.states={},t.states.activeItem="all",n.find({filter:{fields:{channelId:!0,channelTitle:!0},order:name}}).$promise.then(function(e){t.categories=t.categories.concat(e)}),t.selectChannel=function(t){e.$emit("selectFilter",t)}}]}}).directive("collectionSidebar",function(){return{restrict:"A",replace:!0,scope:{user:"="},templateUrl:"views/directives/sidebar/collection-sidebar.html",controller:["$rootScope","$scope","$filter","$window","ModalService","Collection",function(e,t,o,n,r,l){t.open=function(e){r.showModal({templateUrl:"views/modal/channel/channel-add.html",controller:"ChannelModalControllers"}).then(function(e){e.element.modal(),e.close.then(function(e){null!=e&&i(e)})})};var i=function(e){l.create(e).$promise.then(function(e){console.log(e),n.location.reload()},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){})}}]}}).directive("mypageSidebar",function(){return{restrict:"A",replace:!0,scope:{user:"="},templateUrl:"views/directives/sidebar/mypage-sidebar.html",controller:["$rootScope","$window","$scope","$filter","$http","Collection","LoopBackAuth","ModalService","User","Youtube","Config","Content",function(e,t,o,n,r,l,i,c,s,u,a,d){o.LoopBackAuth=i,o.myCollection={},s.collection({userId:i.currentUserId}).$promise.then(function(t){null!=t&&(e.$emit("selectMyChannel",t.channelId),u.channel({key:a.youtubeKey,id:t.channelId,part:"statistics"}).$promise.then(function(e){var t=e.items[0].statistics;o.myCollection.viewCount=t.viewCount,o.myCollection.commentCount=t.commentCount,o.myCollection.subscriberCount=t.subscriberCount,o.myCollection.videoCount=t.videoCount}),f(t.channelId).then(function(e){o.myCollection.count=e}),o.myCollection=t)},function(e){console.log("err :: "+JSON.stringify(e))}),o.CollectById=function(){o.myCollection.state=!0,r({method:"POST",url:"/executeById",headers:{"Content-Type":"application/json; charset=utf-8"},data:{channelId:o.myCollection.channelId},type:"json"}).success(function(e){var t=JSON.parse(JSON.stringify(e));console.log(t)}).finally(function(){console.log("Complete")})},o.colletMyYoutube=function(e){c.showModal({templateUrl:"views/modal/channel/my-channel-add.html",controller:"MyChannelModalControllers"}).then(function(e){e.element.modal(),e.close.then(function(e){e&&p(e)})})},o.deleteCollection=function(e,o){c.showModal({templateUrl:"views/modal/confirm/confirm.html",controller:"ConfirmModalControllers"}).then(function(o){o.element.modal(),o.close.then(function(o){o&&l.delete({id:e}).$promise.then(function(e){t.location.reload()},function(e){console.log("err :: "+JSON.stringify(e))})})})};var p=function(e){l.create(e).$promise.then(function(e){console.log(e),t.location.reload()},function(e){console.log("err :: "+JSON.stringify(e))}).finally(function(){})},f=function(e){var t=d.count({where:{channelId:e}}).$promise.then(function(e){return e.count},function(e){console.log("err :: "+JSON.stringify(e))});return t}}]}}),angular.module("app").controller("ChannelModalControllers",["$scope","close","Youtube","Config",function(e,t,o,n){function r(e){return new Promise(function(t,n){o.channel(e).$promise.then(function(e){return t(e)})})}e.channelDetail=function(t){e.resultText=null,e.enroll_button=!0,e.param={type:"youtube",id:t.items[0].id,channelId:t.items[0].id,channelTitle:t.items[0].snippet.title,publishedAt:t.items[0].snippet.publishedAt,thumbnails:t.items[0].snippet.thumbnails,description:t.items[0].snippet.description,pageInfo:t.pageInfo,state:!1},e.$apply()},e.close=function(e){t(null,500)},e.ok=function(){e.resultText="Searching...",r({key:n.youtubeKey,id:e.addChannel,part:"snippet"}).then(function(t){t.items.length>0?e.channelDetail(t):r({key:n.youtubeKey,forUsername:e.addChannel,part:"snippet"}).then(function(t){t.items.length>0?e.channelDetail(t):(e.resultText="Youtube ID Not Found!",e.$apply())})})},e.enroll=function(){t(e.param,500)}}]),angular.module("app").controller("MyChannelModalControllers",["$scope","$http","close","Youtube","Config","LoopBackAuth",function(e,t,o,n,r,l){null!=l.youtubeAccessToken&&(t.defaults.headers.common.Authorization="Bearer "+l.youtubeAccessToken,n.myChannel({part:"snippet"}).$promise.then(function(t){e.resultText=null,e.enroll_button=!0,e.param={userId:l.currentUserId,type:"youtube",id:t.items[0].id,channelId:t.items[0].id,channelTitle:t.items[0].snippet.title,publishedAt:t.items[0].snippet.publishedAt,thumbnails:t.items[0].snippet.thumbnails,description:t.items[0].snippet.description,pageInfo:t.pageInfo,state:!1}})),e.cancel=function(){o(!1,500)},e.enroll=function(){o(e.param,500)}}]),angular.module("app").controller("ConfirmModalControllers",["$scope","close",function(e,t){e.cancel=function(){t(!1,500)},e.ok=function(){t(!0,500)}}]),angular.module("app").controller("LoginModalControllers",["$scope","$http","$auth","$document","$location","close","Youtube","Config","LoopBackAuth",function(e,t,o,n,r,l,i,c,s){console.log("LoopBackAuth",s),e.authenticate=function(e){o.authenticate(e).then(function(e){s.setUser(e.data.token,e.data.id,e.data.email,e.data.youtubeAccessToken),s.rememberMe=!0,s.save(),angular.element(n[0].getElementsByClassName("modal-backdrop")).remove(),r.url("/mypage")})},e.close=function(e){l(null,500)},e.ok=function(){console.log("LoopBackAuth",s)},e.enroll=function(){l(e.param,500)}}]);